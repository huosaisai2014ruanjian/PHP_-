(function(f,d){f.IMSDK={};var e={onInitialized:null,onDisConnected:null,onConnected:null,onConnectedError:null,onTextReceived:null,onImageReceived:null,onVoiceReceived:null,onTeamTextReceived:null,onTeamImageReceived:null,onTeamVoiceReceived:null,onSystemMsgReceived:null};f.IMSDK=function(w,y){if(w==null||typeof(w)!=="string"||w.length==0){return}var E=this;d.extend(this,{VERSION:"0.0.1"});var a=d.extend({accepts:"",cache:false,crossDomain:true,dataType:"json",type:"POST",timeout:30000,contentType:"application/json",xhrFields:{withCredentials:true},beforeSend:function(g,h){g.setRequestHeader("x-rid",Date.now());g.setRequestHeader("x-imsdk-id",this.imsdk_id)}},f.Global_Config);var J="http://";var v="/v1";var b=J+"rest.imsdk.im"+v;d.extend(this,e,y);var x=false;var B=false;this.current={cid:null,photo:null,nick_name:null};this.app_key=w;this.imsdk_id="";var D=b;var H={REGISTER:D+"/reg",LOGIN:D+"/login",LOGOUT:D+"/logout",GET_USER:D+"/user/{cid}",FRIENDS:D+"/friends",MSG:D+"/msg",NEW_MSG:D+"/online",GET_GROUP:D+"/groups/{tid}"};this.setLogging=function(g){x=g==true?true:false};this.register=function(h,i,k,g){(k&&typeof(k)=="function")||(k=function(){});(g&&typeof(g)=="function")||(g=function(){});if(B){g.call(E,-2,"重复的登录，要更换登录用户，请先登录");return}if(typeof(h)!=="string"||h.length==0){g.call(E,4,"Token 不能为空");return}var j=d.extend(i,{token:h,app_key:this.app_key,nick_name:"",photo:""});I(this,H.REGISTER,j,function(l,m){B=true;this.current.cid=l;k.call(this,l)},g)};this.login=function(j,i,h,g){(h&&typeof(h)=="function")||(h=function(){});(g&&typeof(g)=="function")||(g=function(){});if(B){g.call(this,-2,"重复的登录，要更换登录用户，请先登出");return}var k={app_key:this.app_key,cid:j,password:i};I(this,H.LOGIN,k,function(l){B=true;this.imsdk_id=l.IMSDKID;delete l.IMSDKID;d.extend(this.current,l);G.call(this);h.call(this,l)},g)};this.logout=function(g,h){(g&&typeof(g)=="function")||(g=function(){});(h&&typeof(h)=="function")||(h=function(){});I(this,H.LOGOUT,{},function(i){B=false;d.extend(this.current,{});g.call(this,i)},h)};this.getStatus=function(){return B};var A={};this.getUserInfo=function(j){var g=null;if(!(g=A[j])){try{var i=H.GET_USER.replace("{cid}",j);var h=z(this,i,{});if(h.code==0){A[j]=g=h.data}else{g={cid:j}}}catch(k){g={cid:j}}}return g};var F={};this.getGroup=function(j){var h=null;if(!(h=F[j])){try{var i=H.GET_GROUP.replace("{tid}",j);var g=z(this,i,{});if(g.code==0){F[j]=h=g.data[0]}else{h={group_id:j}}}catch(k){h={group_id:j}}}return h};this.getFriends=function(g){var h=H.FRIENDS;return z(this,h,{})};this.sendUserMsg=function(i,g,h){(g&&typeof(g)=="function")||(g=function(){});(h&&typeof(h)=="function")||(h=function(){});i.target_type="user";I(this,H.MSG,i,g,h)};this.sendTeamMsg=function(i,g,h){(g&&typeof(g)=="function")||(g=function(){});(h&&typeof(h)=="function")||(h=function(){});i.target_type="team";I(this,H.MSG,i,g,h)};var C=function(h,g,i){I(this,H.MSG,h,g,i)};var I=function(j,h,g,k,l){var i=c({url:h,data:f.IMSDK.ParamsBuilder.buildPostData(g),context:j||this,complete:function(p,m){try{var o=p.responseJSON;if(o.status==0){k.call(E,o.data,g)}else{l.call(E,o.status,o.error_msg,g)}}catch(n){l.call(E,-1,"请求应答异常")}}});d.ajax(i)};var z=function(h,k,j){var i=null;var g=c({url:k,data:j,type:"GET",async:false,context:h||this,complete:function(l,m){try{var o=l.responseJSON;if(o.status==0){i={code:0,data:o.data}}else{i={code:o.status,error_msg:o.error_msg}}}catch(n){i={code:-1,error_msg:n}}}});d.ajax(g);return i};var G=function(){if(!B){E.onDisConnected&&typeof(E.onDisConnected)==="function"&&E.onDisConnected.call(E);return}var g=H.NEW_MSG;var h=c({url:g,data:{},type:"GET",context:E,complete:function(l,k){var j=true;try{var i=l.responseJSON;switch(i.status){case 0:var n=i.data;d.each(n,function(r,o){var q=o.type;switch(q){case"p2p":try{switch(o.msg_type){case"voice":E.onVoiceReceived&&typeof(E.onVoiceReceived)==="function"&&E.onVoiceReceived.call(E,o);break;case"img":E.onImageReceived&&typeof(E.onImageReceived)==="function"&&E.onImageReceived.call(E,o);break;default:E.onTextReceived&&typeof(E.onTextReceived)==="function"&&E.onTextReceived.call(E,o);break}}catch(p){}break;case"team":d(E).trigger("team.msg.recv",o);break}});break;case 4:B=false;break;case 1:case 2:case 3:console.error("get msg error - [ code:"+i.status+" msg:"+i.error_msg+"]");j=false;break;default:console.error("get msg error - [ code:"+i.status+" msg:"+i.error_msg+"]");break}}catch(m){console.warn("get msg exception - "+m)}if(j){G.call(E)}}});d.ajax(h)};var c=function(g){var h={};d.extend(true,h,a,g);return h};d(E).bind("team.msg.recv",function(j,o){try{var n=o.to_team_id;var i=o.send_time;var k=o.content;var g=o.from_cid;var m=o.msg_type;var p=this.getUserInfo(g);var h=this.getGroup(n);switch(m){case"voice":this.onTeamVoiceReceived&&typeof(this.onTeamVoiceReceived)==="function"&&this.onTeamVoiceReceived.call(this,msg);break;case"img":this.onTeamImageReceived&&typeof(this.onTeamImageReceived)==="function"&&this.onTeamImageReceived.call(this,msg);break;default:this.onTeamTextReceived&&typeof(this.onTeamTextReceived)==="function"&&this.onTeamTextReceived.call(this,p,h,new Date(i*1000),k);break}}catch(l){}});this.onInitialized&&typeof(this.onInitialized)==="function"&&this.onInitialized({app_key:this.app_key})};f.IMSDK.ParamsBuilder=function(){return{buildPostData:function(a){if(typeof(a)!=="object"){return null}return JSON.stringify(a)}}}()}(window,jQuery));
